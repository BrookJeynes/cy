#!/usr/bin/env bash
# Wrapper for commands that need the go toolchain.
this_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

image="golang:1.12"
container="cy-dev"

if ! docker ps -f name="$container" | grep -q "$container"; then
  # Remove the container after running
  args="--rm "

  # For interactivity
  args+="-it "

  # Don't connect our TTY to the container
  args+="--detach "

  # Go caching mechanism
  args+="--env GOCACHE=/app/cy/.cache "

  # Mount in the current directory
  args+="--volume=$this_dir:/app/cy/ "
  args+="-w /app/cy/ "

  # Make it so file reads/writes are done with the current user
  uid="$(id -u)"
  args+="--user $uid:$uid "

  # Kill the container when the init process dies (helpful sometimes)
  args+="--init "

  args+="--name $container "
  args+="$image "

  docker run $args > /dev/null
fi

docker exec -it $container $@
